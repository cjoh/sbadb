// Generated by CoffeeScript 1.3.3
(function() {
  var $;

  $ = jQuery;

  $.fn.extend({
    mapSearch: function(options) {
      var el, makeAjaxRequest, map, processResults, settings,
        _this = this;
      el = this;
      settings = {
        initial_coordinates: [40, -100],
        initial_zoom: 4,
        tile_layer: 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        per_page: 10,
        geo_params: ['ne_lat', 'ne_lng', 'sw_lat', 'sw_lng'],
        json_selector: '',
        result_params: {
          id: 'id',
          latlng: function(result) {
            return [result.latitude, result.longitude];
          }
        },
        ajax: {
          url: '',
          type: 'GET'
        }
      };
      settings = $.extend(settings, options);
      map = L.map(el[0]).setView(settings.initial_coordinates, settings.initial_zoom);
      L.tileLayer(settings.tile_layer).addTo(map);
      console.log('initialized with settings:');
      console.log(settings);
      makeAjaxRequest = function() {
        return $.ajax({
          url: settings.ajax.url,
          type: settings.ajax.method,
          success: function(data) {
            if (settings.json_selector) {
              return processResults(data[settings.json_selector]);
            } else {
              return processResults(data);
            }
          }
        });
      };
      processResults = function(results) {
        return $(results).each(function(key, result) {
          return L.marker(settings.result_params.latlng(result)).addTo(map);
        });
      };
      map.on('dragend zoomend', function() {
        return makeAjaxRequest();
      });
      return arguments.callee.checkSettings = function() {
        return console.log(settings);
      };
    }
  });

}).call(this);
